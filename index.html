<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forma — Spatial Reasoning Engine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ─── TOKENS ─────────────────────────────────────────────────────────────── */
    :root {
      --bg:        #07090f;
      --bg2:       #0c0f1a;
      --surf:      #0f1219;
      --surf2:     #161c2d;
      --surf3:     #1d2540;
      --border:    #1e2740;
      --border2:   #2a3558;
      --indigo:    #6366f1;
      --indigo-lt: #818cf8;
      --glow:      rgba(99,102,241,0.12);
      --glow2:     rgba(99,102,241,0.06);
      --text:      #e2e8f0;
      --text2:     #94a3b8;
      --text3:     #64748b;
      --text4:     #334155;
      --green:     #10b981;
      --red:       #ef4444;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg); color: var(--text);
      font-family: 'Inter', system-ui, sans-serif; line-height: 1.6;
      min-height: 100vh; overflow-x: hidden;
    }

    /* ─── NAV ─────────────────────────────────────────────────────────────────── */
    nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200; height: 56px;
      display: flex; align-items: center; justify-content: space-between; padding: 0 2rem;
      background: rgba(7,9,15,0.82);
      backdrop-filter: blur(16px) saturate(1.4); -webkit-backdrop-filter: blur(16px) saturate(1.4);
      border-bottom: 1px solid var(--border);
    }
    .nav-left  { display: flex; align-items: center; gap: 1.25rem; }
    .nav-right { display: flex; align-items: center; gap: 0.6rem; }
    .nav-logo  { font-size: 1.05rem; font-weight: 800; letter-spacing: -0.04em; }
    .nav-logo .a { color: var(--indigo-lt); }
    .nav-pill {
      display: flex; align-items: center; gap: 0.35rem;
      background: var(--surf); border: 1px solid var(--border);
      border-radius: 999px; padding: 0.18rem 0.65rem;
      font-size: 0.7rem; font-weight: 600; color: var(--text3);
    }
    .live-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); box-shadow: 0 0 5px var(--green); }
    .btn-ghost {
      display: flex; align-items: center; gap: 0.4rem;
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 8px; padding: 0.28rem 0.7rem;
      font-size: 0.75rem; font-weight: 600; cursor: pointer; font-family: inherit;
      transition: border-color 0.15s, color 0.15s, background 0.15s; position: relative;
    }
    .btn-ghost:hover { border-color: var(--indigo); color: var(--text); background: var(--glow2); }
    .h-badge {
      position: absolute; top: -5px; right: -5px;
      background: var(--indigo); color: #fff; border-radius: 999px;
      font-size: 0.6rem; font-weight: 700; min-width: 16px; height: 16px;
      display: none; align-items: center; justify-content: center; padding: 0 3px;
      border: 2px solid var(--bg);
    }
    .btn-nav-primary {
      background: var(--indigo); color: #fff; border: none;
      border-radius: 8px; padding: 0.32rem 0.9rem;
      font-size: 0.78rem; font-weight: 700; cursor: pointer; text-decoration: none; font-family: inherit;
      transition: background 0.15s, transform 0.1s;
    }
    .btn-nav-primary:hover { background: var(--indigo-lt); transform: translateY(-1px); }

    /* ─── PASSWORD GATE ────────────────────────────────────────────────────────── */
    #pw-gate {
      display: none; position: fixed; inset: 0; z-index: 900;
      background: var(--bg); align-items: center; justify-content: center;
    }
    .pw-card {
      background: var(--surf); border: 1px solid var(--border2); border-radius: 18px;
      padding: 2.5rem 2rem; width: 100%; max-width: 380px; text-align: center;
    }
    .pw-logo { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.04em; margin-bottom: 0.5rem; }
    .pw-logo span { color: var(--indigo-lt); }
    .pw-desc { font-size: 0.85rem; color: var(--text3); margin-bottom: 1.5rem; }
    .pw-input {
      width: 100%; background: var(--surf2); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-size: 0.9rem;
      padding: 0.75rem 1rem; font-family: inherit; outline: none;
      transition: border-color 0.15s; margin-bottom: 0.75rem; text-align: center;
      letter-spacing: 0.1em;
    }
    .pw-input:focus { border-color: var(--indigo); }
    .pw-err { font-size: 0.78rem; color: #f87171; margin-top: 0.5rem; min-height: 1.2rem; }

    /* ─── HERO ──────────────────────────────────────────────────────────────────── */
    .hero {
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; padding: 8rem 1.5rem 5rem; position: relative; overflow: hidden;
    }
    .hero::before {
      content: ''; position: absolute; inset: 0;
      background-image: linear-gradient(rgba(30,39,64,0.45) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(30,39,64,0.45) 1px, transparent 1px);
      background-size: 64px 64px;
      mask-image: radial-gradient(ellipse 80% 55% at 50% 0%, black 0%, transparent 100%);
      -webkit-mask-image: radial-gradient(ellipse 80% 55% at 50% 0%, black 0%, transparent 100%);
    }
    .hero::after {
      content: ''; position: absolute; top: -8%; left: 50%; transform: translateX(-50%);
      width: 1000px; height: 520px;
      background: radial-gradient(ellipse, rgba(99,102,241,0.14) 0%, transparent 65%);
      pointer-events: none;
    }
    .hero-inner { position: relative; z-index: 1; max-width: 780px; }
    .hero-eyebrow {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: var(--surf); border: 1px solid var(--border2); border-radius: 999px;
      padding: 0.28rem 0.9rem; font-size: 0.68rem; font-weight: 700; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--text3); margin-bottom: 2rem;
    }
    .eyebrow-tag {
      background: var(--glow); border: 1px solid rgba(99,102,241,0.3); color: var(--indigo-lt);
      padding: 0.08rem 0.45rem; border-radius: 4px; font-size: 0.62rem; font-weight: 700;
    }
    .hero h1 {
      font-size: clamp(3.2rem, 9vw, 6.8rem); font-weight: 800;
      letter-spacing: -0.055em; line-height: 0.93; margin-bottom: 1.5rem;
    }
    .hero h1 em {
      font-style: normal;
      background: linear-gradient(125deg, var(--indigo-lt) 0%, #a78bfa 45%, #60a5fa 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .hero-sub {
      font-size: clamp(0.95rem, 2vw, 1.15rem); color: var(--text2);
      max-width: 560px; margin: 0 auto 2.5rem; line-height: 1.75;
    }
    .hero-actions { display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap; }
    .btn-hero {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: var(--indigo); color: #fff; border: none;
      padding: 0.82rem 1.8rem; border-radius: 12px;
      font-size: 0.95rem; font-weight: 700; cursor: pointer; text-decoration: none; font-family: inherit;
      transition: background 0.15s, transform 0.12s, box-shadow 0.15s;
    }
    .btn-hero:hover { background: var(--indigo-lt); transform: translateY(-2px); box-shadow: 0 10px 36px rgba(99,102,241,0.32); }
    .btn-hero svg { width: 17px; height: 17px; }
    .btn-demo {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: none; color: var(--text2); border: 1px solid var(--border2);
      padding: 0.82rem 1.5rem; border-radius: 12px;
      font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: inherit;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-demo:hover { border-color: var(--indigo); color: var(--text); }
    .hero-specs {
      display: flex; align-items: center; justify-content: center; flex-wrap: wrap;
      margin-top: 4rem; padding-top: 3rem; border-top: 1px solid var(--border);
    }
    .spec { text-align: center; padding: 0 2.25rem; border-right: 1px solid var(--border); }
    .spec:last-child { border-right: none; }
    .spec-val { font-size: 1.1rem; font-weight: 800; letter-spacing: -0.03em; }
    .spec-val .hi { color: var(--indigo-lt); }
    .spec-key { font-size: 0.7rem; color: var(--text3); font-weight: 500; margin-top: 0.1rem; }

    /* ─── TOOL SECTION ───────────────────────────────────────────────────────────── */
    #tool { padding: 5rem 1.5rem 8rem; }
    .tool-wrap { max-width: 1100px; margin: 0 auto; }
    .tool-header { text-align: center; margin-bottom: 3rem; }
    .sec-tag { display: inline-block; font-size: 0.68rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--indigo-lt); margin-bottom: 0.6rem; }
    .sec-title { font-size: clamp(1.7rem, 4vw, 2.4rem); font-weight: 800; letter-spacing: -0.04em; margin-bottom: 0.5rem; }
    .sec-sub { font-size: 0.9rem; color: var(--text2); }
    .tool-grid { display: grid; grid-template-columns: 360px 1fr; gap: 1.25rem; align-items: start; }

    /* ── Input Panel ── */
    .input-panel { display: flex; flex-direction: column; gap: 0.85rem; }
    .panel-card { background: var(--surf); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .pc-head {
      display: flex; align-items: center; gap: 0.55rem;
      padding: 0.7rem 1rem; border-bottom: 1px solid var(--border); background: var(--surf2);
    }
    .pc-icon {
      width: 26px; height: 26px; background: var(--glow); border: 1px solid rgba(99,102,241,0.2);
      border-radius: 7px; display: flex; align-items: center; justify-content: center; color: var(--indigo-lt);
    }
    .pc-icon svg { width: 13px; height: 13px; }
    .pc-label { font-size: 0.78rem; font-weight: 700; color: var(--text); }
    .pc-sub   { font-size: 0.68rem; color: var(--text3); margin-left: auto; }

    /* Upload Zone */
    .upload-zone {
      padding: 1.5rem 1.25rem; display: flex; flex-direction: column;
      align-items: center; text-align: center; cursor: pointer;
      position: relative; transition: background 0.15s;
      min-height: 150px; justify-content: center; gap: 0.55rem;
    }
    .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
    .upload-zone:hover, .upload-zone.drag { background: var(--glow2); }
    .uz-icon {
      width: 42px; height: 42px; background: var(--surf2); border: 1px solid var(--border2);
      border-radius: 11px; display: flex; align-items: center; justify-content: center;
      color: var(--indigo-lt); transition: border-color 0.15s;
    }
    .upload-zone:hover .uz-icon, .upload-zone.drag .uz-icon { border-color: var(--indigo); }
    .uz-title { font-size: 0.83rem; font-weight: 700; color: var(--text); }
    .uz-sub   { font-size: 0.72rem; color: var(--text3); }
    .uz-row   { display: flex; align-items: center; gap: 0.5rem; }
    .uz-paste { font-size: 0.66rem; color: var(--text4); display: flex; align-items: center; gap: 0.3rem; }
    .kbd {
      background: var(--surf3); border: 1px solid var(--border2); border-radius: 4px;
      padding: 0.04rem 0.3rem; font-size: 0.62rem; font-family: 'JetBrains Mono', monospace; color: var(--text3);
    }
    .uz-divider { font-size: 0.65rem; color: var(--text4); }
    .btn-camera {
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 6px; padding: 0.18rem 0.6rem; font-size: 0.68rem; font-weight: 600;
      cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 0.3rem;
      transition: border-color 0.15s, color 0.15s; position: relative; z-index: 1;
    }
    .btn-camera:hover { border-color: var(--indigo); color: var(--indigo-lt); }
    .btn-camera input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    /* Preview */
    #preview-wrap { display: none; }
    .preview-img-wrap { position: relative; overflow: hidden; }
    #preview-img { width: 100%; max-height: 220px; object-fit: contain; display: block; background: #0a0c16; }
    #ann-canvas {
      position: absolute; inset: 0; width: 100%; height: 100%;
      display: none; cursor: crosshair; touch-action: none;
    }
    .preview-bar {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.55rem 0.85rem; border-top: 1px solid var(--border);
    }
    .preview-name { font-size: 0.72rem; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .preview-actions { display: flex; align-items: center; gap: 0.35rem; }
    .btn-ann {
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 6px; padding: 0.18rem 0.55rem; font-size: 0.68rem; font-weight: 600;
      cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 0.28rem;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-ann:hover { border-color: var(--indigo); color: var(--indigo-lt); }
    .btn-ann.active { border-color: var(--indigo); color: var(--indigo-lt); background: var(--glow); }
    .btn-remove {
      background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.25); color: #f87171;
      border-radius: 6px; padding: 0.18rem 0.55rem; font-size: 0.68rem; font-weight: 700;
      cursor: pointer; font-family: inherit; transition: background 0.15s;
    }
    .btn-remove:hover { background: rgba(239,68,68,0.22); }
    .compress-info { font-size: 0.62rem; color: var(--text4); white-space: nowrap; }

    /* Mode selector */
    .mode-wrap { padding: 0.85rem 1rem; }
    .mode-label { font-size: 0.68rem; font-weight: 700; color: var(--text3); letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.55rem; }
    .mode-tabs { display: grid; grid-template-columns: repeat(3,1fr); gap: 0.35rem; }
    .mode-tab {
      background: var(--surf2); border: 1px solid var(--border); border-radius: 8px;
      padding: 0.45rem 0.2rem; text-align: center; cursor: pointer; font-family: inherit;
      transition: border-color 0.15s, background 0.15s;
    }
    .mode-tab:hover:not(.active) { border-color: var(--border2); }
    .mode-tab.active { background: var(--glow); border-color: rgba(99,102,241,0.45); }
    .mt-name { font-size: 0.75rem; font-weight: 700; color: var(--text); display: block; }
    .mode-tab.active .mt-name { color: var(--indigo-lt); }
    .mt-desc { font-size: 0.62rem; color: var(--text3); display: block; margin-top: 0.1rem; }

    /* Question */
    .q-wrap { padding: 0 1rem 0.85rem; }
    .q-label {
      font-size: 0.68rem; font-weight: 700; color: var(--text3); letter-spacing: 0.05em; text-transform: uppercase;
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.45rem;
    }
    .q-shortcut { font-size: 0.62rem; color: var(--text4); font-weight: 400; letter-spacing: 0; text-transform: none; }
    .q-input {
      width: 100%; background: var(--surf2); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-size: 0.85rem;
      padding: 0.7rem 0.9rem; resize: none; min-height: 80px;
      font-family: inherit; transition: border-color 0.15s; outline: none; line-height: 1.55;
    }
    .q-input::placeholder { color: var(--text4); }
    .q-input:focus { border-color: var(--indigo); }
    .chips { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.55rem; }
    .chip {
      background: var(--surf2); border: 1px solid var(--border); border-radius: 999px;
      padding: 0.18rem 0.65rem; font-size: 0.67rem; color: var(--text3);
      cursor: pointer; font-family: inherit; transition: border-color 0.15s, color 0.15s;
    }
    .chip:hover { border-color: var(--indigo); color: var(--indigo-lt); }
    .submit-wrap { padding: 0 1rem 1rem; }
    .btn-submit {
      width: 100%; background: var(--indigo); color: #fff; border: none;
      border-radius: 10px; padding: 0.78rem; font-size: 0.88rem; font-weight: 700;
      cursor: pointer; font-family: inherit;
      transition: background 0.15s, transform 0.1s, opacity 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 0.45rem;
    }
    .btn-submit:hover:not(:disabled) { background: var(--indigo-lt); transform: translateY(-1px); }
    .btn-submit:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    .spinner { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.25); border-top-color: #fff; border-radius: 50%; animation: spin 0.65s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Output Panel ── */
    .output-panel { position: sticky; top: 68px; }
    .output-card {
      background: var(--surf); border: 1px solid var(--border); border-radius: 14px;
      overflow: hidden; min-height: 520px; display: flex; flex-direction: column;
    }
    .out-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 1.1rem; border-bottom: 1px solid var(--border); background: var(--surf2); flex-shrink: 0;
    }
    .out-head-left  { display: flex; align-items: center; gap: 0.55rem; }
    .out-head-right { display: flex; align-items: center; gap: 0.4rem; }
    .out-badge {
      background: var(--glow); border: 1px solid rgba(99,102,241,0.28); color: var(--indigo-lt);
      border-radius: 5px; padding: 0.12rem 0.5rem; font-size: 0.67rem; font-weight: 700; letter-spacing: 0.06em;
    }
    .out-title { font-size: 0.8rem; font-weight: 600; color: var(--text2); }
    .icon-btn {
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 7px; padding: 0.25rem 0.55rem; font-size: 0.68rem; font-weight: 600;
      cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 0.3rem;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }
    .icon-btn svg { width: 11px; height: 11px; }
    .icon-btn:hover:not(:disabled) { border-color: var(--indigo); color: var(--indigo-lt); }
    .icon-btn:disabled { opacity: 0.28; cursor: default; }
    .icon-btn.ok { border-color: var(--green) !important; color: var(--green) !important; }

    /* Meta bar */
    .out-meta {
      display: none; align-items: center; gap: 1rem; padding: 0.45rem 1.1rem;
      border-bottom: 1px solid var(--border); background: var(--bg2);
      font-size: 0.67rem; color: var(--text4); font-family: 'JetBrains Mono', monospace; flex-shrink: 0;
    }
    .meta-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--indigo-lt); }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.25;} }
    .meta-dot.pulse { animation: pulse 1s infinite; }

    /* Empty state */
    .empty-state {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 3rem 2rem; text-align: center; gap: 1.25rem;
    }
    .empty-icon {
      width: 58px; height: 58px; background: var(--surf2); border: 1px solid var(--border);
      border-radius: 18px; display: flex; align-items: center; justify-content: center; color: var(--text4);
    }
    .empty-icon svg { width: 26px; height: 26px; }
    .empty-title { font-size: 0.92rem; font-weight: 700; color: var(--text3); letter-spacing: -0.02em; }
    .empty-sub   { font-size: 0.78rem; color: var(--text4); max-width: 240px; line-height: 1.65; }
    .empty-specs { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 240px; }
    .espec {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.45rem 0.7rem; background: var(--surf2); border: 1px solid var(--border); border-radius: 7px;
      font-size: 0.68rem;
    }
    .espec-k { color: var(--text3); }
    .espec-v { color: var(--text2); font-weight: 600; font-family: 'JetBrains Mono', monospace; font-size: 0.66rem; }
    .espec-v .g { color: var(--green); } .espec-v .i { color: var(--indigo-lt); }

    /* Skeleton */
    .skel-wrap { display: none; flex-direction: column; gap: 0.65rem; padding: 1.5rem 1.1rem; flex: 1; }
    .skel {
      height: 11px; border-radius: 5px;
      background: linear-gradient(90deg, var(--surf2) 25%, var(--surf3) 50%, var(--surf2) 75%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }

    /* Conversation thread */
    .conv-thread { display: none; padding: 1rem 1.1rem 0; flex-shrink: 0; }
    .conv-turn { margin-bottom: 0.85rem; }
    .conv-q {
      background: var(--surf2); border: 1px solid var(--border2); border-radius: 8px;
      padding: 0.55rem 0.8rem; font-size: 0.75rem; color: var(--text2); margin-bottom: 0.4rem;
    }
    .conv-q-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.06em; color: var(--text4); text-transform: uppercase; margin-bottom: 0.25rem; }
    .conv-a {
      padding: 0.6rem 0.8rem; font-family: 'JetBrains Mono', monospace;
      font-size: 0.76rem; line-height: 1.75; color: var(--text3);
      border-left: 2px solid var(--border2); margin-left: 0.25rem;
    }
    .conv-a .step-num { color: var(--indigo-lt); font-weight: 600; }
    .conv-divider { height: 1px; background: var(--border); margin: 0.75rem 0 1rem; }

    /* Response body */
    .resp-body {
      display: none; flex: 1; overflow-y: auto; padding: 1.25rem 1.1rem; max-height: 55vh;
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
      line-height: 1.9; color: #c4cee6; white-space: pre-wrap; word-break: break-word;
    }
    .step-num { color: var(--indigo-lt); font-weight: 600; }
    .cursor { display: inline-block; width: 7px; height: 1.05em; background: var(--indigo-lt); vertical-align: text-bottom; animation: blink 1s step-end infinite; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0;} }

    /* Error */
    .err-bar {
      display: none; padding: 0.7rem 1.1rem;
      background: rgba(239,68,68,0.06); border-top: 1px solid rgba(239,68,68,0.18);
      color: #fca5a5; font-size: 0.78rem; align-items: flex-start; gap: 0.5rem; flex-shrink: 0;
    }
    .err-bar svg { width: 13px; height: 13px; color: var(--red); flex-shrink: 0; margin-top: 2px; }

    /* Output footer */
    .out-foot {
      display: none; flex-direction: row; align-items: center; justify-content: space-between;
      padding: 0.5rem 1.1rem; border-top: 1px solid var(--border);
      background: var(--bg2); font-size: 0.65rem; color: var(--text4);
      font-family: 'JetBrains Mono', monospace; flex-shrink: 0;
    }
    .foot-tag { background: var(--glow2); border: 1px solid rgba(99,102,241,0.15); color: var(--indigo-lt); border-radius: 4px; padding: 0.04rem 0.35rem; font-weight: 600; }

    /* Follow-up */
    .followup-section {
      display: none; border-top: 1px solid var(--border); background: var(--surf2); flex-shrink: 0;
    }
    .fu-wrap { display: flex; align-items: flex-end; gap: 0.5rem; padding: 0.7rem 1.1rem; }
    .fu-input {
      flex: 1; background: var(--surf3); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 0.82rem;
      padding: 0.55rem 0.8rem; resize: none; height: 38px; font-family: inherit;
      transition: border-color 0.15s; outline: none; line-height: 1.4;
    }
    .fu-input::placeholder { color: var(--text4); }
    .fu-input:focus { border-color: var(--indigo); }
    .fu-btn {
      background: var(--indigo); color: #fff; border: none; border-radius: 8px;
      padding: 0.55rem 0.8rem; cursor: pointer; font-family: inherit; flex-shrink: 0;
      display: flex; align-items: center; transition: background 0.15s;
    }
    .fu-btn:hover { background: var(--indigo-lt); }
    .fu-btn svg { width: 14px; height: 14px; }
    .fu-hint { font-size: 0.62rem; color: var(--text4); padding: 0 1.1rem 0.5rem; }

    /* Share URL */
    .share-bar {
      display: none; padding: 0.55rem 1.1rem; border-top: 1px solid var(--border);
      background: var(--bg2); align-items: center; gap: 0.5rem; flex-shrink: 0;
    }
    .share-url {
      flex: 1; background: var(--surf2); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text2); font-size: 0.7rem;
      padding: 0.3rem 0.6rem; font-family: 'JetBrains Mono', monospace;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text;
    }
    .btn-copy-url {
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 6px; padding: 0.25rem 0.55rem; font-size: 0.68rem; font-weight: 600;
      cursor: pointer; font-family: inherit; transition: border-color 0.15s, color 0.15s; white-space: nowrap;
    }
    .btn-copy-url:hover { border-color: var(--indigo); color: var(--indigo-lt); }

    /* ─── CAPABILITIES ───────────────────────────────────────────────────────────── */
    #capabilities { padding: 5rem 1.5rem; background: var(--bg2); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .cap-wrap   { max-width: 960px; margin: 0 auto; }
    .cap-header { text-align: center; margin-bottom: 3rem; }
    .cap-grid {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: 14px; overflow: hidden;
    }
    .cap-item { background: var(--surf); padding: 1.6rem 1.4rem; transition: background 0.15s; }
    .cap-item:hover { background: var(--surf2); }
    .cap-num   { font-size: 0.6rem; font-weight: 700; color: var(--text4); font-family: 'JetBrains Mono', monospace; letter-spacing: 0.06em; margin-bottom: 0.9rem; }
    .cap-title { font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 0.45rem; letter-spacing: -0.02em; }
    .cap-desc  { font-size: 0.78rem; color: var(--text3); line-height: 1.6; }

    /* ─── FOOTER ─────────────────────────────────────────────────────────────────── */
    .footer-inner {
      max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem;
      border-top: 1px solid var(--border);
    }
    .footer-logo { font-size: 0.88rem; font-weight: 700; color: var(--text3); letter-spacing: -0.02em; }
    .footer-logo span { color: var(--indigo-lt); }
    .footer-copy { font-size: 0.72rem; color: var(--text4); }

    /* ─── HISTORY SIDEBAR ─────────────────────────────────────────────────────────── */
    .overlay { display: none; position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.55); backdrop-filter: blur(4px); }
    .overlay.open { display: block; }
    .sidebar {
      position: fixed; top: 0; right: 0; bottom: 0; width: 380px; z-index: 301;
      background: var(--surf); border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
      transform: translateX(100%); transition: transform 0.25s cubic-bezier(0.16,1,0.3,1);
    }
    .sidebar.open { transform: translateX(0); }
    .sb-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); background: var(--surf2); flex-shrink: 0;
    }
    .sb-title { font-size: 0.85rem; font-weight: 700; color: var(--text); }
    .btn-sb-close {
      background: none; border: 1px solid var(--border); color: var(--text3);
      border-radius: 7px; padding: 0.22rem 0.55rem; font-size: 0.72rem; font-weight: 600;
      cursor: pointer; font-family: inherit; display: flex; align-items: center; gap: 0.25rem;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-sb-close:hover { border-color: var(--red); color: #f87171; }
    .sb-body { flex: 1; overflow-y: auto; padding: 1rem; }
    .sb-empty { text-align: center; padding: 3rem 1rem; color: var(--text4); font-size: 0.8rem; }
    .h-item { background: var(--surf2); border: 1px solid var(--border); border-radius: 10px; padding: 0.9rem 1rem; margin-bottom: 0.7rem; cursor: pointer; transition: border-color 0.15s; }
    .h-item:hover { border-color: var(--indigo); }
    .h-item-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.45rem; }
    .h-mode { background: var(--glow); border: 1px solid rgba(99,102,241,0.2); color: var(--indigo-lt); border-radius: 4px; padding: 0.08rem 0.38rem; font-size: 0.62rem; font-weight: 700; text-transform: uppercase; }
    .h-time  { font-size: 0.62rem; color: var(--text4); font-family: 'JetBrains Mono', monospace; }
    .h-q     { font-size: 0.78rem; font-weight: 600; color: var(--text2); margin-bottom: 0.3rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .h-a     { font-size: 0.7rem; color: var(--text4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sb-foot { padding: 0.7rem 1.25rem; border-top: 1px solid var(--border); flex-shrink: 0; display: flex; justify-content: flex-end; }
    .btn-clear { background: none; border: 1px solid rgba(239,68,68,0.28); color: #f87171; border-radius: 7px; padding: 0.26rem 0.7rem; font-size: 0.72rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: background 0.15s; }
    .btn-clear:hover { background: rgba(239,68,68,0.1); }

    /* ─── RESPONSIVE ─────────────────────────────────────────────────────────────── */
    @media (max-width: 900px) {
      .tool-grid    { grid-template-columns: 1fr; }
      .output-panel { position: static; }
      .cap-grid     { grid-template-columns: 1fr 1fr; }
      .resp-body    { max-height: none; }
    }
    @media (max-width: 600px) {
      nav            { padding: 0 1rem; }
      .nav-pill      { display: none; }
      .hero          { padding: 7rem 1rem 4rem; }
      .hero-specs    { gap: 0; }
      .spec          { padding: 0 1.2rem; }
      #tool          { padding: 3rem 1rem 5rem; }
      #capabilities  { padding: 3rem 1rem; }
      .cap-grid      { grid-template-columns: 1fr; }
      .sidebar       { width: 100%; }
      .footer-inner  { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<!-- ─── PASSWORD GATE ─────────────────────────────────────────────────────────── -->
<div id="pw-gate">
  <div class="pw-card">
    <div class="pw-logo">For<span>m</span>a</div>
    <p class="pw-desc">This instance is password protected.</p>
    <input type="password" id="pw-input" class="pw-input" placeholder="Enter access key" autocomplete="current-password" />
    <button class="btn-submit" id="pw-btn" style="margin-top:0">
      Access Forma
    </button>
    <div class="pw-err" id="pw-err"></div>
  </div>
</div>

<!-- ─── NAV ──────────────────────────────────────────────────────────────────── -->
<nav>
  <div class="nav-left">
    <div class="nav-logo">For<span class="a">m</span>a</div>
    <div class="nav-pill"><span class="live-dot"></span>GPT-4o Vision</div>
  </div>
  <div class="nav-right">
    <button class="btn-ghost" id="history-btn">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      History
      <span class="h-badge" id="h-badge"></span>
    </button>
    <a href="#tool" class="btn-nav-primary">Analyze Image</a>
  </div>
</nav>

<!-- ─── HERO ─────────────────────────────────────────────────────────────────── -->
<section class="hero">
  <div class="hero-inner">
    <div class="hero-eyebrow"><span class="eyebrow-tag">NEW</span>Spatial Reasoning Engine</div>
    <h1>See the structure.<br><em>Reason through it.</em></h1>
    <p class="hero-sub">
      Forma analyzes geometry, spatial relationships, and physical structure in any image —
      delivering step-by-step reasoning for architects, engineers, researchers, and designers.
    </p>
    <div class="hero-actions">
      <a href="#tool" class="btn-hero">
        Analyze an Image
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </a>
      <button class="btn-demo" id="hero-demo-btn">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Try live demo
      </button>
    </div>
    <div class="hero-specs">
      <div class="spec"><div class="spec-val"><span class="hi">GPT-4o</span></div><div class="spec-key">Model</div></div>
      <div class="spec"><div class="spec-val">High<span class="hi">·</span>Detail</div><div class="spec-key">Vision mode</div></div>
      <div class="spec"><div class="spec-val"><span class="hi">3</span> Modes</div><div class="spec-key">Reasoning depth</div></div>
      <div class="spec"><div class="spec-val">20<span class="hi">MB</span></div><div class="spec-key">Max image size</div></div>
    </div>
  </div>
</section>

<!-- ─── TOOL SECTION ──────────────────────────────────────────────────────────── -->
<section id="tool">
  <div class="tool-wrap">
    <div class="tool-header">
      <div class="sec-tag">Reasoning Engine</div>
      <h2 class="sec-title">Analyze any spatial image</h2>
      <p class="sec-sub">Geometry problems, floor plans, diagrams, blueprints — ask anything.</p>
    </div>
    <div class="tool-grid">

      <!-- ── Input ── -->
      <div class="input-panel">

        <!-- Upload card -->
        <div class="panel-card" id="upload-card">
          <div class="pc-head">
            <div class="pc-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </div>
            <span class="pc-label">Image Input</span>
            <span class="pc-sub">PNG · JPG · WEBP · GIF</span>
          </div>
          <!-- Drop zone -->
          <div class="upload-zone" id="upload-zone">
            <input type="file" id="file-input" accept="image/*" />
            <div class="uz-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <p class="uz-title">Drop image here</p>
            <p class="uz-sub">or click to browse</p>
            <div class="uz-row">
              <p class="uz-paste"><span class="kbd">Ctrl</span>+<span class="kbd">V</span>&nbsp;to paste</p>
              <span class="uz-divider">·</span>
              <button class="btn-camera" onclick="event.stopPropagation()">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                Camera
                <input type="file" id="camera-input" accept="image/*" capture="environment" />
              </button>
            </div>
          </div>
          <!-- Preview -->
          <div id="preview-wrap">
            <div class="preview-img-wrap">
              <img id="preview-img" src="" alt="Preview" />
              <canvas id="ann-canvas"></canvas>
            </div>
            <div class="preview-bar">
              <span class="preview-name" id="preview-name"></span>
              <span class="compress-info" id="compress-info"></span>
              <div class="preview-actions">
                <button class="btn-ann" id="ann-btn">
                  <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                  Region
                </button>
                <button class="btn-ann" id="clear-ann-btn" style="display:none">Clear</button>
                <button class="btn-remove" id="remove-btn">Remove</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Mode -->
        <div class="panel-card">
          <div class="pc-head">
            <div class="pc-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M4.22 4.22l2.12 2.12m11.32 11.32 2.12 2.12M2 12h3m14 0h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/></svg></div>
            <span class="pc-label">Reasoning Mode</span>
          </div>
          <div class="mode-wrap">
            <div class="mode-label">Depth</div>
            <div class="mode-tabs">
              <button class="mode-tab" data-mode="quick"><span class="mt-name">Quick</span><span class="mt-desc">2–3 steps</span></button>
              <button class="mode-tab active" data-mode="deep"><span class="mt-name">Deep</span><span class="mt-desc">Full walkthrough</span></button>
              <button class="mode-tab" data-mode="expert"><span class="mt-name">Expert</span><span class="mt-desc">Technical precision</span></button>
            </div>
          </div>
        </div>

        <!-- Question -->
        <div class="panel-card">
          <div class="pc-head">
            <div class="pc-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
            <span class="pc-label">Question</span>
          </div>
          <div class="q-wrap">
            <label class="q-label" for="q-input">
              WHAT DO YOU WANT TO KNOW?
              <span class="q-shortcut"><span class="kbd">Ctrl</span>+<span class="kbd">↵</span></span>
            </label>
            <textarea class="q-input" id="q-input" placeholder='e.g. "What is the area?" / "Will a queen bed fit?" / "Which angle is obtuse?"'></textarea>
            <div class="chips">
              <button class="chip">Area of this shape?</button>
              <button class="chip">Will it fit?</button>
              <button class="chip">Which angle is largest?</button>
              <button class="chip">How many floors?</button>
            </div>
          </div>
          <div class="submit-wrap">
            <button class="btn-submit" id="submit-btn" disabled>
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
              Analyze Image
            </button>
          </div>
        </div>

      </div><!-- /input-panel -->

      <!-- ── Output ── -->
      <div class="output-panel">
        <div class="output-card">
          <div class="out-head">
            <div class="out-head-left">
              <span class="out-badge">FORMA</span>
              <span class="out-title">Spatial Reasoning Output</span>
            </div>
            <div class="out-head-right">
              <button class="icon-btn" id="share-btn" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                Share
              </button>
              <button class="icon-btn" id="copy-btn" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy
              </button>
              <button class="icon-btn" id="export-btn" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export
              </button>
            </div>
          </div>

          <div class="out-meta" id="out-meta">
            <span class="meta-dot pulse" id="meta-dot"></span>
            <span id="meta-status">streaming</span>
            <span>·</span><span id="meta-model">gpt-4o</span>
            <span>·</span><span id="meta-mode">deep</span>
            <span>·</span><span id="meta-chars">0 chars</span>
          </div>

          <div class="empty-state" id="empty-state">
            <div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg></div>
            <div class="empty-title">Awaiting spatial input</div>
            <div class="empty-sub">Upload an image and ask a question to begin.</div>
            <div class="empty-specs">
              <div class="espec"><span class="espec-k">model</span><span class="espec-v"><span class="i">gpt-4o</span></span></div>
              <div class="espec"><span class="espec-k">vision</span><span class="espec-v"><span class="g">high-detail</span></span></div>
              <div class="espec"><span class="espec-k">output</span><span class="espec-v">step-by-step</span></div>
              <div class="espec"><span class="espec-k">streaming</span><span class="espec-v"><span class="g">enabled</span></span></div>
            </div>
          </div>

          <div class="skel-wrap" id="skel-wrap">
            <div class="skel" style="width:55%"></div><div class="skel" style="width:90%"></div>
            <div class="skel" style="width:78%"></div><div class="skel" style="width:85%"></div>
            <div class="skel" style="width:40%"></div><div class="skel" style="width:92%"></div>
            <div class="skel" style="width:65%"></div>
          </div>

          <!-- Conversation thread (previous turns) -->
          <div class="conv-thread" id="conv-thread"></div>

          <div class="resp-body" id="resp-body">
            <span id="stream-text"></span><span class="cursor" id="cursor"></span>
          </div>

          <div class="err-bar" id="err-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <span id="err-text"></span>
          </div>

          <div class="out-foot" id="out-foot">
            <span id="foot-info"></span>
            <span class="foot-tag" id="foot-mode"></span>
          </div>

          <!-- Share URL bar -->
          <div class="share-bar" id="share-bar">
            <span style="font-size:.67rem;color:var(--text3);white-space:nowrap;font-weight:600;">Share link:</span>
            <span class="share-url" id="share-url"></span>
            <button class="btn-copy-url" id="copy-url-btn">Copy link</button>
          </div>

          <!-- Follow-up input -->
          <div class="followup-section" id="followup-section">
            <div class="fu-wrap">
              <textarea class="fu-input" id="fu-input" placeholder="Ask a follow-up about the same image…" rows="1"></textarea>
              <button class="fu-btn" id="fu-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              </button>
            </div>
            <div class="fu-hint">Ctrl+↵ to send · Same image, new question</div>
          </div>

        </div>
      </div><!-- /output-panel -->

    </div>
  </div>
</section>

<!-- ─── CAPABILITIES ────────────────────────────────────────────────────────── -->
<section id="capabilities">
  <div class="cap-wrap">
    <div class="cap-header">
      <div class="sec-tag">Capabilities</div>
      <h2 class="sec-title">Engineered for real spatial work</h2>
      <p class="sec-sub">Not a homework shortcut — a precision reasoning system for anyone who works with visual space.</p>
    </div>
    <div class="cap-grid">
      <div class="cap-item"><div class="cap-num">01</div><div class="cap-title">Geometric Analysis</div><div class="cap-desc">Measures angles, classifies polygons, and walks through area and perimeter derivations step by step.</div></div>
      <div class="cap-item"><div class="cap-num">02</div><div class="cap-title">Architectural Parsing</div><div class="cap-desc">Reads floor plans and blueprints to answer layout questions, furniture fit, and circulation paths.</div></div>
      <div class="cap-item"><div class="cap-num">03</div><div class="cap-title">Structural Reasoning</div><div class="cap-desc">Identifies load-bearing elements, symmetry axes, and physical constraints in engineering diagrams.</div></div>
      <div class="cap-item"><div class="cap-num">04</div><div class="cap-title">Diagram Interpretation</div><div class="cap-desc">Decodes schematics, network graphs, and technical charts — articulating relationships and hierarchies.</div></div>
      <div class="cap-item"><div class="cap-num">05</div><div class="cap-title">Scale &amp; Proportion</div><div class="cap-desc">Estimates real-world dimensions from images, compares relative sizes, and validates scale consistency.</div></div>
      <div class="cap-item"><div class="cap-num">06</div><div class="cap-title">3D Orientation</div><div class="cap-desc">Reasons about depth, perspective, and three-dimensional structure from 2D projections and photographs.</div></div>
    </div>
  </div>
</section>

<footer><div class="footer-inner">
  <div class="footer-logo"><span>Forma</span> — Spatial Reasoning Engine</div>
  <div class="footer-copy">Built by Arihant Lodha &nbsp;·&nbsp; Powered by GPT-4o Vision</div>
</div></footer>

<!-- ─── HISTORY SIDEBAR ─────────────────────────────────────────────────────── -->
<div class="overlay" id="overlay"></div>
<div class="sidebar" id="sidebar">
  <div class="sb-head">
    <span class="sb-title">Analysis History</span>
    <button class="btn-sb-close" id="sidebar-close">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      Close
    </button>
  </div>
  <div class="sb-body" id="sb-body"></div>
  <div class="sb-foot"><button class="btn-clear" id="clear-hist-btn">Clear history</button></div>
</div>

<script>
/* ─── DOM ──────────────────────────────────────────────────────────────────── */
const uploadZone   = document.getElementById('upload-zone');
const fileInput    = document.getElementById('file-input');
const cameraInput  = document.getElementById('camera-input');
const previewWrap  = document.getElementById('preview-wrap');
const previewImg   = document.getElementById('preview-img');
const previewName  = document.getElementById('preview-name');
const compressInfo = document.getElementById('compress-info');
const removeBtn    = document.getElementById('remove-btn');
const annBtn       = document.getElementById('ann-btn');
const clearAnnBtn  = document.getElementById('clear-ann-btn');
const annCanvas    = document.getElementById('ann-canvas');
const annCtx       = annCanvas.getContext('2d');
const modeTabs     = document.querySelectorAll('.mode-tab');
const qInput       = document.getElementById('q-input');
const chips        = document.querySelectorAll('.chip');
const submitBtn    = document.getElementById('submit-btn');
const emptyState   = document.getElementById('empty-state');
const skelWrap     = document.getElementById('skel-wrap');
const convThread   = document.getElementById('conv-thread');
const respBody     = document.getElementById('resp-body');
const streamText   = document.getElementById('stream-text');
const cursor       = document.getElementById('cursor');
const errBar       = document.getElementById('err-bar');
const errText      = document.getElementById('err-text');
const outMeta      = document.getElementById('out-meta');
const metaDot      = document.getElementById('meta-dot');
const metaStatus   = document.getElementById('meta-status');
const metaMode     = document.getElementById('meta-mode');
const metaChars    = document.getElementById('meta-chars');
const outFoot      = document.getElementById('out-foot');
const footInfo     = document.getElementById('foot-info');
const footMode     = document.getElementById('foot-mode');
const copyBtn      = document.getElementById('copy-btn');
const exportBtn    = document.getElementById('export-btn');
const shareBtn     = document.getElementById('share-btn');
const shareBar     = document.getElementById('share-bar');
const shareUrl     = document.getElementById('share-url');
const copyUrlBtn   = document.getElementById('copy-url-btn');
const followupSec  = document.getElementById('followup-section');
const fuInput      = document.getElementById('fu-input');
const fuBtn        = document.getElementById('fu-btn');
const historyBtn   = document.getElementById('history-btn');
const hBadge       = document.getElementById('h-badge');
const overlay      = document.getElementById('overlay');
const sidebar      = document.getElementById('sidebar');
const sidebarClose = document.getElementById('sidebar-close');
const sbBody       = document.getElementById('sb-body');
const clearHistBtn = document.getElementById('clear-hist-btn');
const pwGate       = document.getElementById('pw-gate');
const pwInput      = document.getElementById('pw-input');
const pwBtn        = document.getElementById('pw-btn');
const pwErr        = document.getElementById('pw-err');
const heroDemoBtn  = document.getElementById('hero-demo-btn');

/* ─── STATE ──────────────────────────────────────────────────────────────────── */
let selectedFile     = null;
let currentMode      = 'deep';
let lastAnswer       = '';
let lastQuestion     = '';
let startTime        = 0;
let charCount        = 0;
let chatHistory      = [];       // [{role, text}]
let convImageFile    = null;     // image used for current conversation
let annRect          = null;     // {x,y,w,h} in canvas display coords
let isAnnotating     = false;
let isDrawing        = false;
let annStart         = null;
let history          = JSON.parse(localStorage.getItem('forma-history') || '[]');
const storedKey      = () => sessionStorage.getItem('forma-key') || '';

/* ─── AUTH ──────────────────────────────────────────────────────────────────── */
async function initAuth() {
  try {
    const r = await fetch('/ping');
    const { protected: prot } = await r.json();
    if (!prot) return;
    if (storedKey()) return;
    pwGate.style.display = 'flex';
    pwInput.focus();
  } catch { /* offline / error — skip gate */ }
}

async function doAuth() {
  const key = pwInput.value.trim();
  if (!key) return;
  pwBtn.disabled = true;
  try {
    const r = await fetch('/auth', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({key}) });
    const { ok } = await r.json();
    if (ok) {
      sessionStorage.setItem('forma-key', key);
      pwGate.style.display = 'none';
    } else {
      pwErr.textContent = 'Incorrect access key.';
    }
  } catch { pwErr.textContent = 'Could not connect to server.'; }
  finally { pwBtn.disabled = false; }
}

pwBtn.addEventListener('click', doAuth);
pwInput.addEventListener('keydown', e => { if (e.key === 'Enter') doAuth(); });

function authHeaders() {
  const k = storedKey();
  return k ? { 'X-Forma-Key': k } : {};
}

/* ─── IMAGE COMPRESSION ──────────────────────────────────────────────────────── */
async function compressImage(file, maxSide = 1600, quality = 0.88) {
  return new Promise(resolve => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let { naturalWidth: w, naturalHeight: h } = img;
      if (Math.max(w, h) <= maxSide) { resolve(file); return; }
      const ratio = maxSide / Math.max(w, h);
      w = Math.round(w * ratio); h = Math.round(h * ratio);
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      c.toBlob(blob => {
        if (!blob) { resolve(file); return; }
        const name = file.name.replace(/\.[^.]+$/, '.jpg');
        resolve(new File([blob], name, { type: 'image/jpeg' }));
      }, 'image/jpeg', quality);
    };
    img.onerror = () => resolve(file);
    img.src = url;
  });
}

function fmtSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' KB';
  return (bytes / 1024 / 1024).toFixed(1) + ' MB';
}

/* ─── FILE HANDLING ──────────────────────────────────────────────────────────── */
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault(); uploadZone.classList.remove('drag');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) handleFile(f);
});
fileInput.addEventListener('change',  () => { if (fileInput.files[0])  handleFile(fileInput.files[0]); });
cameraInput.addEventListener('change', () => { if (cameraInput.files[0]) handleFile(cameraInput.files[0]); });

async function handleFile(file) {
  const orig = fmtSize(file.size);
  selectedFile = file;
  previewImg.src = URL.createObjectURL(file);
  previewName.textContent = file.name;
  compressInfo.textContent = orig;
  uploadZone.style.display = 'none';
  previewWrap.style.display = 'block';
  clearAnnotation();
  resetConversation();
  updateSubmit();

  // Show compression delta after image loads
  previewImg.onload = async () => {
    const compressed = await compressImage(file);
    if (compressed !== file) {
      compressInfo.textContent = `${orig} → ${fmtSize(compressed.size)}`;
    }
  };
}

removeBtn.addEventListener('click', () => {
  selectedFile = null;
  previewWrap.style.display = 'none';
  uploadZone.style.display = '';
  previewImg.src = '';
  fileInput.value = '';
  cameraInput.value = '';
  clearAnnotation();
  resetConversation();
  updateSubmit();
});

/* ─── CLIPBOARD PASTE ─────────────────────────────────────────────────────────── */
document.addEventListener('paste', e => {
  const items = e.clipboardData?.items;
  if (!items) return;
  for (const item of items) {
    if (item.type.startsWith('image/')) { const f = item.getAsFile(); if (f) { handleFile(f); break; } }
  }
});

/* ─── ANNOTATION ──────────────────────────────────────────────────────────────── */
function syncCanvas() {
  annCanvas.width  = previewImg.clientWidth;
  annCanvas.height = previewImg.clientHeight;
  drawAnn();
}

function drawAnn() {
  annCtx.clearRect(0, 0, annCanvas.width, annCanvas.height);
  if (!annRect) return;
  annCtx.strokeStyle = '#6366f1'; annCtx.lineWidth = 2;
  annCtx.strokeRect(annRect.x, annRect.y, annRect.w, annRect.h);
  annCtx.fillStyle = 'rgba(99,102,241,0.15)';
  annCtx.fillRect(annRect.x, annRect.y, annRect.w, annRect.h);
}

function clearAnnotation() {
  annRect = null; isAnnotating = false; isDrawing = false; annStart = null;
  annCanvas.style.display = 'none';
  annBtn.classList.remove('active');
  clearAnnBtn.style.display = 'none';
  annCtx.clearRect(0, 0, annCanvas.width, annCanvas.height);
}

annBtn.addEventListener('click', () => {
  if (isAnnotating) { isAnnotating = false; annBtn.classList.remove('active'); return; }
  syncCanvas();
  annCanvas.style.display = 'block';
  isAnnotating = true;
  annBtn.classList.add('active');
});

clearAnnBtn.addEventListener('click', clearAnnotation);

function pointerPos(e, isTouch) {
  const r = annCanvas.getBoundingClientRect();
  const src = isTouch ? e.touches[0] : e;
  return { x: src.clientX - r.left, y: src.clientY - r.top };
}

['mousedown', 'touchstart'].forEach(evt => {
  annCanvas.addEventListener(evt, e => {
    if (!isAnnotating) return;
    if (evt === 'touchstart') e.preventDefault();
    const p = pointerPos(e, evt === 'touchstart');
    annStart = p; isDrawing = true; annRect = null;
  }, { passive: false });
});

['mousemove', 'touchmove'].forEach(evt => {
  annCanvas.addEventListener(evt, e => {
    if (!isDrawing) return;
    if (evt === 'touchmove') e.preventDefault();
    const p = pointerPos(e, evt === 'touchmove');
    annRect = { x: Math.min(annStart.x, p.x), y: Math.min(annStart.y, p.y), w: Math.abs(p.x - annStart.x), h: Math.abs(p.y - annStart.y) };
    drawAnn();
  }, { passive: false });
});

['mouseup', 'touchend'].forEach(evt => {
  annCanvas.addEventListener(evt, () => {
    isDrawing = false;
    if (annRect && annRect.w < 5 && annRect.h < 5) { annRect = null; }
    if (annRect) { isAnnotating = false; annBtn.classList.remove('active'); clearAnnBtn.style.display = ''; }
  });
});

async function getImageToSend() {
  const file = await compressImage(selectedFile || convImageFile);
  if (!annRect) return file;
  return new Promise(resolve => {
    const img = previewImg;
    const c = document.createElement('canvas');
    c.width = img.naturalWidth; c.height = img.naturalHeight;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const sx = img.naturalWidth  / annCanvas.width;
    const sy = img.naturalHeight / annCanvas.height;
    ctx.strokeStyle = '#6366f1'; ctx.lineWidth = Math.max(2, 2 * sx);
    ctx.strokeRect(annRect.x * sx, annRect.y * sy, annRect.w * sx, annRect.h * sy);
    ctx.fillStyle = 'rgba(99,102,241,0.15)';
    ctx.fillRect(annRect.x * sx, annRect.y * sy, annRect.w * sx, annRect.h * sy);
    c.toBlob(blob => resolve(new File([blob], 'annotated.png', { type: 'image/png' })), 'image/png');
  });
}

/* ─── MODE ────────────────────────────────────────────────────────────────────── */
modeTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    modeTabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentMode = tab.dataset.mode;
  });
});

/* ─── CHIPS ───────────────────────────────────────────────────────────────────── */
chips.forEach(c => c.addEventListener('click', () => {
  qInput.value = c.textContent; qInput.dispatchEvent(new Event('input')); qInput.focus();
}));

/* ─── QUESTION INPUT ──────────────────────────────────────────────────────────── */
qInput.addEventListener('input', () => {
  qInput.style.height = 'auto';
  qInput.style.height = Math.min(qInput.scrollHeight, 160) + 'px';
  updateSubmit();
});

/* ─── KEYBOARD ────────────────────────────────────────────────────────────────── */
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    if (document.activeElement === fuInput) { if (fuInput.value.trim()) submitFollowup(); }
    else if (!submitBtn.disabled) submit();
  }
  if (e.key === 'Escape') closeSidebar();
});

fuInput.addEventListener('input', () => {
  fuInput.style.height = 'auto';
  fuInput.style.height = Math.min(fuInput.scrollHeight, 120) + 'px';
});

/* ─── SUBMIT STATE ────────────────────────────────────────────────────────────── */
function updateSubmit() {
  submitBtn.disabled = !(selectedFile && qInput.value.trim());
}

/* ─── DEMO ────────────────────────────────────────────────────────────────────── */
heroDemoBtn.addEventListener('click', runDemo);

async function createDemoImage() {
  const svg = `<svg width="480" height="300" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <pattern id="g" width="30" height="30" patternUnits="userSpaceOnUse">
        <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#1e2740" stroke-width="0.6"/>
      </pattern>
    </defs>
    <rect width="480" height="300" fill="#0e1219"/>
    <rect width="480" height="300" fill="url(#g)"/>
    <polygon points="80,240 360,240 360,80" fill="rgba(99,102,241,0.08)" stroke="#6366f1" stroke-width="2"/>
    <polyline points="342,240 342,222 360,222" fill="none" stroke="#6366f1" stroke-width="1.5"/>
    <text x="195" y="265" fill="#94a3b8" font-size="14" font-family="monospace" text-anchor="middle">base = 12 cm</text>
    <line x1="80" y1="272" x2="360" y2="272" stroke="#334155" stroke-width="1"/>
    <text x="375" y="165" fill="#94a3b8" font-size="14" font-family="monospace">h = 9 cm</text>
    <line x1="368" y1="80" x2="368" y2="240" stroke="#334155" stroke-width="1"/>
    <text x="175" y="145" fill="#818cf8" font-size="14" font-family="monospace" transform="rotate(-36,175,145)">c = ?</text>
    <text x="18" y="22" fill="#334155" font-size="11" font-family="monospace">geometry / right-triangle.svg</text>
    <text x="80" y="235" fill="#6366f1" font-size="11" font-family="monospace">A</text>
    <text x="362" y="257" fill="#6366f1" font-size="11" font-family="monospace">B</text>
    <text x="362" y="76" fill="#6366f1" font-size="11" font-family="monospace">C</text>
  </svg>`;
  const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = 480; c.height = 300;
      c.getContext('2d').drawImage(img, 0, 0);
      URL.revokeObjectURL(url);
      c.toBlob(b => resolve(new File([b], 'right-triangle-demo.png', { type: 'image/png' })), 'image/png');
    };
    img.src = url;
  });
}

async function runDemo() {
  heroDemoBtn.disabled = true;
  heroDemoBtn.textContent = 'Loading…';
  try {
    const demoFile = await createDemoImage();
    await handleFile(demoFile);
    qInput.value = 'What is the area of this right triangle? Also find the length of the missing side c.';
    qInput.dispatchEvent(new Event('input'));
    document.getElementById('tool').scrollIntoView({ behavior: 'smooth' });
    setTimeout(() => { if (!submitBtn.disabled) submit(); }, 600);
  } finally {
    heroDemoBtn.disabled = false;
    heroDemoBtn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg> Try live demo`;
  }
}

/* ─── SUBMIT ──────────────────────────────────────────────────────────────────── */
submitBtn.addEventListener('click', submit);

async function submit() {
  if (!selectedFile || !qInput.value.trim()) return;
  lastQuestion = qInput.value.trim();
  lastAnswer   = ''; charCount = 0; startTime = Date.now();
  convImageFile = selectedFile;

  setLoadingUI();

  const imgToSend = await getImageToSend();
  const fd = new FormData();
  fd.append('image', imgToSend);
  fd.append('question', lastQuestion);
  fd.append('mode', currentMode);
  if (chatHistory.length) fd.append('history', JSON.stringify(chatHistory));

  await doRequest(fd);
}

/* ─── FOLLOW-UP ───────────────────────────────────────────────────────────────── */
fuBtn.addEventListener('click', submitFollowup);

async function submitFollowup() {
  const q = fuInput.value.trim();
  if (!q || !convImageFile) return;
  lastQuestion = q; lastAnswer = ''; charCount = 0; startTime = Date.now();
  fuInput.value = ''; fuInput.style.height = 'auto';

  // Archive current response into conversation thread
  archiveTurn(lastQuestion.slice(0, -q.length + lastQuestion.length), /* already archived below */ false);

  setLoadingUI(true /* isFollowup */);

  const imgToSend = await compressImage(convImageFile);  // no annotation for follow-ups
  const fd = new FormData();
  fd.append('image', imgToSend);
  fd.append('question', q);
  fd.append('mode', currentMode);
  fd.append('history', JSON.stringify(chatHistory));

  await doRequest(fd);
}

async function doRequest(fd) {
  try {
    const res = await fetch('/analyze', { method: 'POST', body: fd, headers: authHeaders() });
    if (res.status === 401) {
      const d = await res.json();
      if (d.auth) { sessionStorage.removeItem('forma-key'); pwGate.style.display = 'flex'; pwInput.focus(); }
      else showError(d.error || 'Unauthorized');
      resetSubmitBtn(); return;
    }
    if (!res.ok) { const d = await res.json(); throw new Error(d.error || `Server error ${res.status}`); }
    await streamResponse(res);
  } catch (err) {
    showError(err.message);
  } finally {
    resetSubmitBtn();
  }
}

function setLoadingUI(isFollowup = false) {
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<div class="spinner"></div> Analyzing…';
  fuBtn.disabled = true;
  copyBtn.disabled = true; exportBtn.disabled = true; shareBtn.disabled = true;
  errBar.style.display = 'none';
  shareBar.style.display = 'none';

  if (!isFollowup) {
    emptyState.style.display = 'none';
    convThread.style.display = 'none';
    convThread.innerHTML = '';
  }
  respBody.style.display  = 'none';
  outFoot.style.display   = 'none';
  followupSec.style.display = 'none';
  skelWrap.style.display  = 'flex';

  outMeta.style.display   = 'flex';
  metaDot.classList.add('pulse');
  metaStatus.textContent  = 'streaming';
  metaMode.textContent    = currentMode;
  metaChars.textContent   = '0 chars';
}

function resetSubmitBtn() {
  submitBtn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Analyze Image`;
  fuBtn.disabled = false;
  updateSubmit();
}

/* ─── STREAMING ───────────────────────────────────────────────────────────────── */
async function streamResponse(res) {
  const reader = res.body.getReader(); const decoder = new TextDecoder(); let buf = '';
  skelWrap.style.display = 'none';
  streamText.textContent = '';
  if (!cursor.parentNode) respBody.appendChild(cursor);
  respBody.style.display = 'block';

  while (true) {
    const { done, value } = await reader.read(); if (done) break;
    buf += decoder.decode(value, { stream: true });
    const msgs = buf.split('\n\n'); buf = msgs.pop();
    for (const msg of msgs) {
      const line = msg.trim(); if (!line.startsWith('data: ')) continue;
      const data = line.slice(6).trim();
      if (data === '[DONE]') { finishStream(); return; }
      try {
        const p = JSON.parse(data);
        if (p.error) { showError(p.error); return; }
        if (p.token) appendToken(p.token);
      } catch { /**/ }
    }
  }
  finishStream();
}

function appendToken(token) {
  streamText.textContent += token;
  lastAnswer += token; charCount += token.length;
  metaChars.textContent = charCount + ' chars';
  respBody.scrollTop = respBody.scrollHeight;
}

function finishStream() {
  if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
  const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
  respBody.innerHTML = formatResponse(lastAnswer);
  metaDot.classList.remove('pulse');
  metaStatus.textContent = '✓ complete';
  metaChars.textContent  = charCount + ' chars';
  outFoot.style.display  = 'flex';
  footInfo.textContent   = `${charCount} chars · ${elapsed}s · gpt-4o`;
  footMode.textContent   = currentMode;
  copyBtn.disabled  = false; exportBtn.disabled = false; shareBtn.disabled = false;
  followupSec.style.display = 'block';

  // Append to conversation history
  chatHistory.push({ role: 'user', text: lastQuestion });
  chatHistory.push({ role: 'assistant', text: lastAnswer });
  saveHistory(lastQuestion, lastAnswer, currentMode);
  respBody.scrollTop = 0;
}

function archiveTurn(unusedQ, force) {
  // Move current resp-body content into conversation thread
  const prevQ = chatHistory.length >= 2 ? chatHistory[chatHistory.length - 2].text : lastQuestion;
  const prevA = chatHistory.length >= 1 ? chatHistory[chatHistory.length - 1].text : lastAnswer;
  if (!prevA) return;

  if (convThread.children.length === 0) {
    // First archived turn — show thread
    convThread.style.display = 'block';
  }

  const div = document.createElement('div');
  div.className = 'conv-turn';
  div.innerHTML = `
    <div class="conv-q"><div class="conv-q-label">Q</div>${escHtml(prevQ)}</div>
    <div class="conv-a">${formatResponse(prevA)}</div>
    <div class="conv-divider"></div>`;
  convThread.appendChild(div);
  convThread.scrollTop = convThread.scrollHeight;
}

/* ─── CONVERSATION RESET ──────────────────────────────────────────────────────── */
function resetConversation() {
  chatHistory = []; convImageFile = null;
  convThread.innerHTML = ''; convThread.style.display = 'none';
  respBody.style.display = 'none'; respBody.innerHTML = '';
  streamText.textContent = '';
  if (!cursor.parentNode) respBody.appendChild(cursor);
  outFoot.style.display = 'none'; outMeta.style.display = 'none';
  shareBar.style.display = 'none'; followupSec.style.display = 'none';
  errBar.style.display = 'none';
  emptyState.style.display = 'flex';
  copyBtn.disabled = true; exportBtn.disabled = true; shareBtn.disabled = true;
  lastAnswer = ''; lastQuestion = '';
}

/* ─── FOLLOW-UP ARCHIVE HELPER (called before new followup renders) ─────────── */
// Override submitFollowup to properly archive before streaming
const _origSubmitFollowup = submitFollowup;
fuBtn.removeEventListener('click', submitFollowup);
fuBtn.addEventListener('click', async () => {
  const q = fuInput.value.trim();
  if (!q || !convImageFile) return;

  // Archive the currently displayed response first
  if (lastAnswer && chatHistory.length) {
    archiveTurn(null, true);
  }

  lastQuestion = q; lastAnswer = ''; charCount = 0; startTime = Date.now();
  fuInput.value = ''; fuInput.style.height = 'auto';

  setLoadingUI(true);

  const imgToSend = await compressImage(convImageFile);
  const fd = new FormData();
  fd.append('image', imgToSend);
  fd.append('question', q);
  fd.append('mode', currentMode);
  fd.append('history', JSON.stringify(chatHistory));
  await doRequest(fd);
});

/* ─── FORMATTING ──────────────────────────────────────────────────────────────── */
function formatResponse(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^(Step\s+\d+[:.)]?|\d+[.)]\s*)/gm, m => `<span class="step-num">${m}</span>`);
}

/* ─── COPY / EXPORT ───────────────────────────────────────────────────────────── */
copyBtn.addEventListener('click', async () => {
  if (!lastAnswer) return;
  try { await navigator.clipboard.writeText(lastAnswer); }
  catch { const ta = document.createElement('textarea'); ta.value = lastAnswer; ta.style.cssText = 'position:fixed;opacity:0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
  copyBtn.classList.add('ok');
  copyBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied`;
  setTimeout(() => { copyBtn.classList.remove('ok'); copyBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy`; }, 2000);
});

exportBtn.addEventListener('click', () => {
  if (!lastAnswer) return;
  const date = new Date().toISOString().slice(0,10);
  const md = `# Forma Analysis\n\n**Question:** ${lastQuestion}\n\n**Mode:** ${currentMode}  \n**Model:** GPT-4o Vision  \n**Date:** ${date}\n\n---\n\n## Analysis\n\n${lastAnswer}\n`;
  const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(new Blob([md],{type:'text/markdown'})), download: `forma-${date}.md` });
  a.click();
});

/* ─── SHARE ───────────────────────────────────────────────────────────────────── */
shareBtn.addEventListener('click', async () => {
  if (!lastAnswer) return;
  shareBtn.disabled = true; shareBtn.innerHTML = `<div class="spinner" style="width:11px;height:11px;border-width:1.5px"></div> Saving`;
  try {
    const res = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify({ question: lastQuestion, answer: lastAnswer, mode: currentMode }),
    });
    const d = await res.json();
    if (d.url) {
      shareUrl.textContent = d.url;
      shareBar.style.display = 'flex';
    }
  } catch { /* ignore */ }
  finally {
    shareBtn.disabled = false;
    shareBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg> Share`;
  }
});

copyUrlBtn.addEventListener('click', async () => {
  const url = shareUrl.textContent;
  try { await navigator.clipboard.writeText(url); } catch { /**/ }
  copyUrlBtn.textContent = 'Copied!';
  setTimeout(() => { copyUrlBtn.textContent = 'Copy link'; }, 2000);
});

/* ─── SHOW ERROR ──────────────────────────────────────────────────────────────── */
function showError(msg) {
  skelWrap.style.display  = 'none';
  respBody.style.display  = 'none';
  errText.textContent     = msg;
  errBar.style.display    = 'flex';
  outMeta.style.display   = 'none';
}

/* ─── HISTORY ──────────────────────────────────────────────────────────────────── */
function saveHistory(question, answer, mode) {
  history.unshift({ id: Date.now(), question, answer, mode, ts: Date.now() });
  if (history.length > 20) history.pop();
  localStorage.setItem('forma-history', JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const n = history.length;
  hBadge.textContent = n; hBadge.style.display = n > 0 ? 'flex' : 'none';
  sbBody.innerHTML = n === 0
    ? '<div class="sb-empty">No analyses yet.</div>'
    : history.map(item => `<div class="h-item" data-id="${item.id}">
        <div class="h-item-top"><span class="h-mode">${item.mode}</span><span class="h-time">${timeAgo(item.ts)}</span></div>
        <div class="h-q">${escHtml(item.question)}</div>
        <div class="h-a">${escHtml(item.answer.slice(0,100))}…</div>
      </div>`).join('');
  sbBody.querySelectorAll('.h-item').forEach(el => {
    el.addEventListener('click', () => {
      const item = history.find(h => h.id === parseInt(el.dataset.id));
      if (item) loadFromHistory(item);
    });
  });
}

function loadFromHistory(item) {
  closeSidebar();
  qInput.value = item.question; qInput.dispatchEvent(new Event('input'));
  currentMode  = item.mode;
  modeTabs.forEach(t => t.classList.toggle('active', t.dataset.mode === item.mode));
  lastAnswer = item.answer; lastQuestion = item.question; charCount = item.answer.length;

  emptyState.style.display = 'none'; skelWrap.style.display = 'none'; errBar.style.display = 'none';
  convThread.style.display = 'none'; convThread.innerHTML = '';
  streamText.textContent = '';
  if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
  respBody.innerHTML = formatResponse(item.answer); respBody.style.display = 'block';
  outMeta.style.display = 'flex'; metaDot.classList.remove('pulse');
  metaStatus.textContent = '✓ restored'; metaMode.textContent = item.mode;
  metaChars.textContent  = item.answer.length + ' chars';
  outFoot.style.display  = 'flex';
  footInfo.textContent   = `${item.answer.length} chars · ${timeAgo(item.ts)} · gpt-4o`;
  footMode.textContent   = item.mode;
  copyBtn.disabled = false; exportBtn.disabled = false; shareBtn.disabled = false;
  shareBar.style.display = 'none'; followupSec.style.display = 'none';
  document.getElementById('tool').scrollIntoView({ behavior: 'smooth' });
  updateSubmit();
}

clearHistBtn.addEventListener('click', () => {
  if (!confirm('Clear all history?')) return;
  history = []; localStorage.removeItem('forma-history'); renderHistory();
});

/* ─── SIDEBAR ──────────────────────────────────────────────────────────────────── */
historyBtn.addEventListener('click', openSidebar);
overlay.addEventListener('click', closeSidebar);
sidebarClose.addEventListener('click', closeSidebar);
function openSidebar()  { overlay.classList.add('open'); sidebar.classList.add('open'); document.body.style.overflow = 'hidden'; }
function closeSidebar() { overlay.classList.remove('open'); sidebar.classList.remove('open'); document.body.style.overflow = ''; }

/* ─── UTILS ────────────────────────────────────────────────────────────────────── */
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(ts) {
  const s = Math.floor((Date.now()-ts)/1000);
  if (s<60) return 'just now'; if (s<3600) return Math.floor(s/60)+'m ago';
  if (s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago';
}

/* ─── INIT ─────────────────────────────────────────────────────────────────────── */
updateSubmit();
renderHistory();
initAuth();
</script>
</body>
</html>
